<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>layout 后台大布局 - Layui</title>
  <link rel="stylesheet" href="/public/layui/css/layui.css">
  <link rel="stylesheet" href="/public/css/nprogress.css">
</head>

<body class="layui-layout-body">
  <div class="layui-layout layui-layout-admin">
    <!--引入头部模板-->
    {{include './common/header.html'}}


    <!--引入左侧模板-->
    {{include './common/side.html'}}


    <div class="layui-body">
      <!-- 内容主体区域 -->
      <div style="padding: 15px;">
        删除文章区域
        <table class="layui-hide" id="test" lay-filter="test"></table>

        <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="show">查看内容</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
      </script>
      </div>
    </div>

    <!--引入底部模板-->
    {{include './common/footer.html'}}
  </div>
  <script src="/public/js/moment.js"></script>
  <script src="/public/js/juqery.js"></script>
  <script src="/public/layui/layui.js"></script>
  <script src="/public/js/util.js"></script>
  <script src="/public/js/nprogress.js"></script>
  <script>
    // 加入 顶部进度条
    NProgress.set(0.4)
    let interval = setInterval(function() {
      NProgress.inc();
    },200)
    $(window).on('load', function() {
      clearInterval(interval)
      NProgress.done();
    })

    //JavaScript代码区域
    layui.use(['element', 'table'], function () {
      var element = layui.element;

      var table = layui.table;

      let tableUI = table.render({
        elem: '#test'
        , url: '/allarticle'
        , toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
        , defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
          title: '提示'
          , layEvent: 'LAYTABLE_TIPS'
          , icon: 'layui-icon-tips'
        }]
        , limit: 5
        , limits: [5, 10, 15, 20]
        , title: '文章数据'
        , cols: [[
          { type: 'checkbox', fixed: 'left' }
          , { field: 'art_id', title: 'ID', width: 80, fixed: 'left', unresize: true, sort: true }
          , { field: 'title', title: '标题', width: 120, edit: 'text' }
          , { field: 'content', title: '内容', width: 120 }
          , { field: 'cat_id', title: '所属分类', width: 150,hide:true}
          , { field: 'author', title: '作者', width: 80, edit: 'text', sort: true }
          , { field: 'cover', title: '照片', width: 100 }
          , {
            field: 'status', title: '状态', unresize: false, templet: (item) => {
              // console.log(status.status);
              let statusMap = {
                "0": '未发布',
                "1": '已发布',
                "2": '审核中'

              }
              return statusMap[item.status];
            }
          }
          , {
            field: 'publish_date', title: '时间', sort: true, templet: (item) => {
              let { publish_date } = item;
              return util.date_format(publish_date)
            }
          }
          , { fixed: 'right', title: '操作', toolbar: '#barDemo' }
        ]]
        , page: true
      });

      // 监听删除、编辑事件
      //监听事件
      table.on('tool(test)', function (obj) {
        let { data, event } = obj;
        let {art_id} = data;
        switch (event) {
          case "del":
            console.log("del", data.art_id);
            del(art_id);
            break;
          case 'edit':
            console.log("edit");
            break;
        }

      });
      // 删除文章
      function del(art_id) {
            layer.confirm('确认删除', {
              btn: ['确定', '取消'] //按钮
            }, function () {
              // 发送ajax 请求
              $.ajax({
                type:'post',
                url:'/delArticle',
                data:{art_id},
              }).then( (res)=>{
                // 成功之后 关闭弹框 重新加载
                let {errcode,message} = res; 
                if(errcode == 0) {
                    // 成功 刷新页面
                    // layer.closeAll(); //疯狂模式，关闭所有层
                    tableUI.reload();  // 重载  
                    layer.msg(message) 
                    
                }
              })
            });
        }

    })

  </script>

</body>

</html>